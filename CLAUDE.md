# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

PR Pal is a Rails 8.0 web application for managing pull requests with LLM integration. It features user authentication, encrypted API key storage for LLM providers, and modern Rails tooling.

## Architecture

### Core Models
- **User**: Authentication with normalized emails and secure passwords, encrypted GitHub tokens
- **Session**: Session management with IP/user agent tracking  
- **LlmApiKey**: Encrypted storage for different LLM provider API keys
- **Repository**: GitHub repository tracking (owner/name)
- **PullRequestReview**: Core PR data with GitHub sync, CI status, comments
- **LlmConversationMessage**: Conversation threads for PR discussions

### GitHub Integration Architecture
- **Data Provider Pattern**: Configurable GitHub API vs dummy data via `USE_DUMMY_DATA` env var
- **Background Sync**: `PullRequestSyncJob` + `PullRequestSyncer` for automated PR updates
- **GitHub API Client**: Octokit-based with retry logic and rate limiting
- **PR Status Tracking**: CI status, comments, reviews synced from GitHub API

### Authentication System
- Custom authentication using `Authentication` concern in controllers
- Session-based auth with signed cookies, no external auth gems
- Rate limiting (10 attempts per 3 minutes) and modern browser requirements

### Frontend Stack
- **Hotwire** (Turbo + Stimulus) for interactive functionality
- **TailwindCSS 4.x** for styling
- **Bun** for JavaScript bundling and dependency management
- Assets build to `app/assets/builds/` directory

## Essential Development Commands

### Setup
```bash
bundle install && bun install
bin/rails db:create db:migrate db:seed
```

### Development Server
```bash
bin/dev  # Starts Rails server + asset watchers (uses Procfile.dev)
```

### Testing
```bash
bin/rails test                    # Run all tests
bin/rails test:system             # Run system tests only
bin/rails test test/models/       # Run specific test directory
bin/rails test test/models/user_test.rb:15  # Run specific test method/line
rake test:coverage                # Run tests with coverage reporting
rake test:coverage_open           # Run tests with coverage and open report
```

### Database Operations
```bash
bin/rails db:migrate
bin/rails db:rollback
bin/rails dbconsole
bin/rails db:reset                # Drop, create, migrate, seed
```

### Asset Building
```bash
bun run build         # JavaScript bundling
bun run build:css     # TailwindCSS compilation
# Add --watch to either for development mode
```

### Code Quality & Type Checking
```bash
bundle exec rubocop              # Ruby linting
bundle exec rubocop -a           # Auto-fix linting issues
bundle exec brakeman             # Security scanning
bundle exec tapioca generate     # Generate RBI files for Sorbet
srb tc                          # Run Sorbet type checker
```

## Deployment (Kamal)

```bash
bin/kamal deploy      # Deploy to production
bin/kamal console     # Rails console on production
bin/kamal shell       # SSH into production container
bin/kamal logs        # Tail production logs
bin/kamal dbc         # Production database console
```

## Key Architectural Patterns

### Data Provider Strategy
Switch between GitHub API and dummy data via environment configuration:
- Set `USE_DUMMY_DATA=true` for development without GitHub API
- Data providers in `app/services/` implement consistent interface
- Configuration via `config/initializers/data_providers.rb`

### Background Processing
- **Solid Queue** for job processing (Rails 8 default)
- `PullRequestSyncJob` syncs all user repositories automatically
- Error handling with fallback to basic PR creation

### Tab Management System
- Session-based PR tab tracking for multi-PR workflows
- Automatic cleanup when repositories are deleted
- Hotwire-powered real-time tab updates

## Architecture Notes

- **Rails 8.0** with Solid Queue/Cache/Cable for background processing
- **SQLite3** database for all environments with persistent volumes in production
- **Propshaft** asset pipeline with Bun instead of traditional Webpacker
- **Docker** deployment using multi-stage builds with Thruster for asset serving
- **Sorbet** type checking with RBI files generated by Tapioca
- Modern Rails patterns: no Devise, no external auth gems, leveraging built-in features

## Testing Setup

Uses **Minitest** with parallel execution, **Capybara + Selenium** for system tests, and fixture-based test data. Tests are organized in standard Rails structure under `test/`. SimpleCov provides coverage reporting with Codecov integration via custom Rake tasks.